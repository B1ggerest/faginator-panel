<!DOCTYPE html>
<html>
<head>
  <title>XOR Key Manager</title>
  <style>
    body { font-family: sans-serif; padding: 40px; text-align: center; background: #f2f2f2 }
    input, button { font-size: 16px; padding: 8px; margin: 5px }
    #panel { display: none; margin-top: 20px }
    ul { list-style: none; padding: 0; margin: 20px auto; max-width: 500px }
    li { background: white; padding: 10px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 5px; text-align: left }
    .key { font-family: monospace; word-break: break-word }
  </style>
</head>
<body>
  <h2>Login</h2>
  <input id="pass" type="password" placeholder="Master Password" />
  <button onclick="login()">Login</button>

  <div id="panel">
    <h3>Key Panel</h3>
    <input id="key" placeholder="Key ID" />
    <input id="name" placeholder="Owner Name" />
    <input id="max" type="number" placeholder="Max Users" />
    <button onclick="addKey()">Add</button>
    <ul id="list"></ul>
  </div>

<script>
const endpoint = "https://YOUR-WORKER-URL.workers.dev";
let keys = {};
let password = "";

function xor(data, key) {
  return Array.from(data).map((char, i) =>
    String.fromCharCode(char.charCodeAt(0) ^ key.charCodeAt(i % key.length))
  ).join("");
}

async function login() {
  password = document.getElementById("pass").value;
  const res = await fetch(endpoint, {
    headers: { Authorization: password }
  });

  if (!res.ok) return alert("Login failed");

  const text = await res.text();
  const decoded = atob(text || "");
  const decrypted = xor(decoded, password);

  try {
    keys = JSON.parse(decrypted || "{}");
  } catch {
    keys = {};
  }

  document.getElementById("panel").style.display = "block";
  document.getElementById("pass").style.display = "none";
  document.querySelector("button").style.display = "none";
  render();
}

function render() {
  const ul = document.getElementById("list");
  ul.innerHTML = "";

  Object.entries(keys).forEach(([id, info]) => {
    const li = document.createElement("li");
    li.innerHTML = `
      <div class="key"><b>${id}</b></div>
      Name: ${info.name}<br>
      Max: ${info.max}, Active: ${info.active}
      <br>
      <button onclick="useKey('${id}')">Use</button>
      <button onclick="releaseKey('${id}')">Release</button>
    `;
    ul.appendChild(li);
  });
}

async function addKey() {
  const id = document.getElementById("key").value.trim();
  const name = document.getElementById("name").value.trim();
  const max = parseInt(document.getElementById("max").value.trim());

  if (!id || !name || !max || keys[id]) return alert("Invalid or duplicate key");

  keys[id] = { name, max, active: 0 };
  await sync(); render();
}

async function useKey(id) {
  if (keys[id].active < keys[id].max) {
    keys[id].active++;
    await sync(); render();
  } else {
    alert("Max users reached.");
  }
}

async function releaseKey(id) {
  if (keys[id].active > 0) {
    keys[id].active--;
    await sync(); render();
  }
}

async function sync() {
  const encoded = JSON.stringify(keys);
  const encrypted = xor(encoded, password);
  const payload = btoa(encrypted);

  await fetch(endpoint, {
    method: "PUT",
    headers: {
      Authorization: password,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ content: payload })
  });
}
</script>
</body>
</html>
