<!DOCTYPE html>
<html>
<head>
  <title>Encrypted Key Manager</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 40px; background: #f9f9f9 }
    input, button { font-size: 16px; padding: 8px; margin: 5px }
    #panel { display: none; margin-top: 20px }
    ul { list-style: none; padding: 0; margin: 20px auto; max-width: 600px }
    li { background: #fff; padding: 10px; border: 1px solid #ccc; margin-bottom: 8px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center }
    .key-info { text-align: left; flex-grow: 1; font-family: monospace; }
  </style>
</head>
<body>
  <h2>Login</h2>
  <input id="pass" type="password" placeholder="Master Password" />
  <button onclick="login()">Login</button>

  <div id="panel">
    <h3>Key Panel</h3>
    <input id="user" placeholder="Username" />
    <input id="key" placeholder="New key" />
    <button onclick="addKey()">Add</button>
    <ul id="list"></ul>
  </div>

<script>
const endpoint = "https://lively-frog-51c2.lolbiggerestlol.workers.dev";
let key = null, iv = null, keys = [];

async function login() {
  const pass = document.getElementById("pass").value;
  const res = await fetch(endpoint, { headers: { Authorization: pass } });
  if (!res.ok) return alert("Login failed");

  const raw = await res.text();
  const inner = JSON.parse(`"${raw}"`);
  const { iv: ivB64, data } = JSON.parse(atob(inner));

  const encKey = await getKey(pass);
  iv = Uint8Array.from(atob(ivB64), c => c.charCodeAt(0));
  const decrypted = await crypto.subtle.decrypt(
    { name: "AES-GCM", iv },
    encKey,
    Uint8Array.from(atob(data), c => c.charCodeAt(0))
  );

  keys = JSON.parse(new TextDecoder().decode(decrypted));
  key = encKey;

  document.getElementById("panel").style.display = "block";
  document.getElementById("pass").style.display = "none";
  document.querySelector("button").style.display = "none";
  render();
}

function render() {
  const ul = document.getElementById("list");
  ul.innerHTML = "";
  keys.forEach(entry => {
    const li = document.createElement("li");
    const div = document.createElement("div");
    div.className = "key-info";
    div.textContent = `Key: ${entry.value}\nUser: ${entry.user} | Active Clients: ${entry.activeClients}`;

    const btn = document.createElement("button");
    btn.textContent = "❌";
    btn.onclick = () => removeKey(entry.value);

    li.appendChild(div);
    li.appendChild(btn);
    ul.appendChild(li);
  });
}

async function addKey() {
  const username = document.getElementById("user").value.trim();
  const val = document.getElementById("key").value.trim();
  if (!val || !username || keys.some(x => x.value === val)) return;

  keys.push({ value: val, user: username, activeClients: 0 });
  document.getElementById("key").value = "";
  document.getElementById("user").value = "";
  await sync(); render();
}

async function removeKey(value) {
  keys = keys.filter(x => x.value !== value);
  await sync(); render();
}

async function sync() {
  const encoded = new TextEncoder().encode(JSON.stringify(keys));
  const newIv = crypto.getRandomValues(new Uint8Array(12));
  const encrypted = await crypto.subtle.encrypt(
    { name: "AES-GCM", iv: newIv },
    key,
    encoded
  );

  const payload = {
    iv: btoa(String.fromCharCode(...newIv)),
    data: btoa(String.fromCharCode(...new Uint8Array(encrypted)))
  };

  await fetch(endpoint, {
    method: "PUT",
    headers: {
      Authorization: document.getElementById("pass").value,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ content: btoa(JSON.stringify(payload)) })
  });
}

async function getKey(pass) {
  const enc = new TextEncoder().encode(pass);
  const keyMaterial = await crypto.subtle.importKey("raw", enc, "PBKDF2", false, ["deriveKey"]);
  return await crypto.subtle.deriveKey(
    {
      name: "PBKDF2",
      salt: new TextEncoder().encode("faginator-salt"),
      iterations: 100000,
      hash: "SHA-256"
    },
    keyMaterial,
    { name: "AES-GCM", length: 256 },
    false,
    ["encrypt", "decrypt"]
  );
}
</script>
</body>
</html>
