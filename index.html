<!DOCTYPE html>
<html>
<head>
  <title>Key Manager</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; padding: 40px; }
    input, button { margin: 5px; padding: 8px; font-size: 16px; }
    #panel { display: none; margin-top: 20px; }
    ul { list-style: none; padding: 0; max-width: 400px; margin: 20px auto; }
    li { background: #fff; margin-bottom: 5px; padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; }
    .key { text-align: left; flex-grow: 1; word-break: break-word; }
  </style>
</head>
<body>
  <h2>Login</h2>
  <input id="pass" type="password" placeholder="Master Password" />
  <button onclick="login()">Login</button>

  <div id="panel">
    <h3>Key Panel</h3>
    <input id="username" placeholder="Username" />
    <input id="key" placeholder="New Key" />
    <button onclick="addKey()">Add</button>
    <ul id="list"></ul>
  </div>

<script>
const endpoint = "https://lively-frog-51c2.lolbiggerestlol.workers.dev";
let keys = [], master = "";

async function login() {
  master = document.getElementById("pass").value;
  const res = await fetch(endpoint, { headers: { Authorization: master } });
  if (!res.ok) return alert("Login failed");
  const encrypted = atob(await res.text());
  const decrypted = xor(encrypted, master);
  keys = JSON.parse(decrypted);
  document.getElementById("panel").style.display = "block";
  document.getElementById("pass").style.display = "none";
  document.querySelector("button").style.display = "none";
  render();
}

function render() {
  const ul = document.getElementById("list");
  ul.innerHTML = "";
  keys.forEach(k => {
    const li = document.createElement("li");
    li.innerHTML = `<span class="key">${k.key} (${k.user}) — Clients: ${k.activeClients}</span>
                    <button onclick="removeKey('${k.key}')">❌</button>`;
    ul.appendChild(li);
  });
}

async function addKey() {
  const name = document.getElementById("username").value.trim();
  const value = document.getElementById("key").value.trim();
  if (!name || !value || keys.find(k => k.key === value)) return;
  keys.push({ key: value, user: name, activeClients: 0 });
  await sync(); render();
}

async function removeKey(val) {
  keys = keys.filter(k => k.key !== val);
  await sync(); render();
}

async function sync() {
  const encrypted = btoa(xor(JSON.stringify(keys), master));
  await fetch(endpoint, {
    method: "PUT",
    headers: {
      Authorization: master,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ content: encrypted })
  });
}

function xor(str, key) {
  return [...str].map((c, i) => String.fromCharCode(c.charCodeAt(0) ^ key.charCodeAt(i % key.length))).join('');
}
</script>
</body>
</html>
